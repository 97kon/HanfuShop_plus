<!doctype html>
<html class="no-js" lang="en">

<head th:replace="home/public/header::head(~{::title},~{},~{})">
    <title>笔记详情-云裳·汉服商城</title>
</head>

<body>
<style type="text/css">
    .breadcrumbs-area {
        padding: 100px 0;
        background: #f6f6f6 url(/static/common/images/hanfu3.jpeg) no-repeat scroll center center/cover;
        background-size: 100% 100%;
    }
    .purchase{
        width: 60px;
        height: 30px;
        border-radius: 10%;
        background-color: red;
        color: whitesmoke;
        text-align: center;
        vertical-align: middle;
        line-height: 30px;
        margin: 0px 10px;
    }
    a.purchase:hover{
        color: white;
    }
    div.product-image{
        overflow: hidden;
    }
    div.product-image img{
        transition: all 0.6s;
        height: 100px;
        width: 200px;
    }
    div.product-image img:hover{
        transform: scale(1.2);
    }
    .x-interact-publish-cont, .x-interact-publish-cont-topic {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        width: 100%;
        background: #f5f5f6;
        border-radius: 12px;
    }
    .x-interact-publish .text-area {
        padding: 16px 16px 23px;
        width: 100%;
        resize: none;
        background: #f5f5f6;
        border-radius: 12px;
        border: none;
        color: #1f1f1f;
    }
    .x-interact-publish {
        width: 100%;
        font-size: 13px;
        color: #222;
    }
    .x-interact-publish-panel-center {
        padding-top: 4px;
    }
    .x-interact-publish .text-area:empty:before {
        content: attr(placeholder);
    }
    .xcp-publish-main .right {
        -webkit-box-flex: 1;
        -ms-flex: 1;
        flex: 1;
    }
    .xcp-publish-main {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -ms-flex-direction: row;
        flex-direction: row;
        padding-top: 20px;
    }
    .x-interact-publish-cont, .x-interact-publish-cont-topic {
        display: -webkit-box;
        display: -ms-flexbox;
        display: flex;
        width: 100%;
        background: #f5f5f6;
        border-radius: 12px;
    }
    .commitComment{
        width: 100%;
        display: flex;
        align-items: flex-start;
        margin: 20px 0;
        flex-direction: row;
        padding-top: 10px;
        border-top: 6px solid rgba(121, 118, 117, 0.75);
    }
    .commitComment img{
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .commitComment .right{
        width: 90%;
    }
    .publishButton{
        padding: 5px 30px;
        background-color: #4e6ef2;
        border-radius: 15px!important;
        color: whitesmoke;
        cursor: pointer;
    }
    .x-interact-publish-opt{
        text-align: right;
        padding: 5px 0;
    }
    .comment-panel{
        width: 100%;
        margin-top: 20px;
        margin-bottom: 80px;
    }
    .comment-panel img{
        width: 48px;
        height: 48px;
        border-radius: 100%;
        margin-right: 20px;
    }
    .comment-panel ul li{
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        margin: 15px 0;
        width: 100%;
    }
    .comment-panel .comment-userName{
        font-weight: bold;
        font-size: 1.2rem;
    }
    .comment-panel .comment-time{
        font-size: 0.8rem;
        height: 24px;
        line-height: 24px;
    }
    .comment-panel .comment-action{
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        width: 100%;
        cursor: pointer;
    }
    .xcp-list-loader {
        margin-top: 64px;
        height: 42px;
        font: 14px PingFangSC-Regular;
        text-align: center;
        line-height: 42px;
        color: #626675;
        background: #f5f5f6;
        border-radius: 6px;
        cursor: pointer;
    }
</style>

    <div class="blog-wrapper">

        <!-- Header Area Start Here -->
        <div th:replace="home/public/header::headmenu"></div>
        <!-- Header Area End Here -->

        <!-- Breadcrumb Area Start Here -->
        <div class="breadcrumbs-area position-relative">
            <div class="container">
                <div class="row">
                    <div class="col-12 text-center">
                        <div class="breadcrumb-content position-relative section-content">
                            <h3 class="title-3">[[${note.title}]]</h3>
                            <ul>
                                <li><a href="/home/index">首页</a></li>
                                <li><a href="/home/note/homeListPage?type=1">笔记列表</a></li>
                                <li>详情</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Breadcrumb Area End Here -->
        <!-- Blog Main Area Start Here -->
        <div class="blog-main-area" id="app">
            <div class="container container-default-2 custom-area">
                <div class="row flex-row-reverse">
                    <div class="col-12 col-custom mt-no-text">
                        <!-- Blog Details wrapper Area Start -->
                        <div class="blog-post-details">
<!--                            <figure class="blog-post-thumb mb-5">-->
<!--                                <img class="w-100" th:src="${'/file/fileDown?saveName='+note.field1}" alt="Blog Image">-->
<!--&lt;!&ndash;                                <img class="w-100" src="/static/assets/images/blog/large-size/1.jpg" alt="Blog Image">&ndash;&gt;-->
<!--                            </figure>-->

                            <section class="blog-post-wrapper product-summery">
                                <div class="section-content">
                                    <blockquote class="blockquote mb-4">
                                        <p>[[${note.title}]]</p>
                                    </blockquote>
                                    <div th:utext="${note.content}"></div>
                                </div>

                                <div class="share-article">
                                    <span class="left-side">
                                        <a th:href="${'/home/note/detail/'+notePriv.id}"> <i class="fa fa-long-arrow-left"></i> Older Post</a>
                                    </span>
                                    <h6 class="text-uppercase" style="color: red">
                                        <span style="font-size: 1.2rem;cursor: pointer;" @click="checkFavor()" title="点我点我">点赞 </span>{{favorNum}}
                                        <span style="font-size: 1.2rem;cursor: pointer;margin-left: 20px" @click="checkCollect()" title="点我点我">收藏 </span>{{collectNum}}
                                    </h6>
                                    <span class="right-side">
                                        <a th:href="${'/home/note/detail/'+noteNext.id}">Newer Post <i class="fa fa-long-arrow-right"></i></a>
                                    </span>
                                </div>
                                <div>
                                    <div class="commitComment">
                                        <img :src="'/file/fileDown?saveName='+userInfo.field1" />
                                        <div  class="right">
                                            <div class="x-interact-publish">
                                                <div class="x-interact-publish-cont">
                                                    <textarea contenteditable="true" v-model="content" class="text-area placeholder" placeholder="发表神评妙论"></textarea>
                                                    <div class="other"></div>
                                                </div>
                                                <div class="x-interact-publish-panel-center">

                                                </div>
                                                <div class="x-interact-publish-opt ">
                                                    <span class="publishButton" @click="addComment()">发表</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="comment-panel">
                                        <p style="font-weight: bold;font-size: 20px">评论列表（{{commentNum}}）</p>
                                        <ul >
                                            <li v-for="item in commentList">
                                                <img :src="'/file/fileDown?saveName='+item.userImg" />
                                                <div style="flex-grow: 1">
                                                    <p class="comment-userName">{{item.userName}}</p>
                                                    <p class="comment-info">{{item.comment}}</p>
                                                    <p class="comment-action" @mouseenter="mouseEnter" @mouseleave="mouseLeave">
                                                        <span class="comment-time">{{item.createTime}}</span>
                                                        <span v-if="item.userId!=currUserId" @click="replyComment(item)">回复</span>
                                                        <span v-if="item.userId==currUserId"  :style="active" @click="deleteComment(item.id)">删除</span>
                                                    </p>
                                                    <div  class="right" :style="showReply" v-if="replyId==item.id">
                                                        <div class="x-interact-publish">
                                                            <div class="x-interact-publish-cont">
                                                                <textarea contenteditable="true" v-model="replyContent" class="text-area placeholder" :placeholder="replyPlaceholder"></textarea>
                                                                <div class="other"></div>
                                                            </div>
                                                            <div class="x-interact-publish-panel-center">

                                                            </div>
                                                            <div class="x-interact-publish-opt ">
                                                                <span class="publishButton" @click="addReplyComment(item)">提交</span>
                                                                <span class="publishButton" @click="cancelReply()">取消</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!--            childchildchildchildchildchildchildchildchildchildchildchildchildchildchild                                        -->
                                                    <div>
                                                        <ul @mouseenter="mouseEnter" @mouseleave="mouseLeave">
                                                            <li v-for="itemChild in item.childList">
                                                                <img :src="'/file/fileDown?saveName='+itemChild.userImg" />
                                                                <div style="flex-grow: 1">
                                                                    <p class="comment-userName">{{itemChild.replyUserName}}</p>
                                                                    <p class="comment-info">{{"@//"+itemChild.userName+" : "+itemChild.comment}}</p>
                                                                    <p class="comment-action" >
                                                                        <span class="comment-time">{{itemChild.createTime}}</span>
                                                                        <span v-if="itemChild.replyUserId!=currUserId" @click="replyCommentChild(itemChild,item)">回复</span>
                                                                        <span v-if="itemChild.replyUserId==currUserId"  :style="active" @click="deleteComment(itemChild.id)" >删除</span>
                                                                    </p>
                                                                    <div  class="right" :style="showReplyChild" v-if="currReplyId==itemChild.id">
                                                                        <div class="x-interact-publish">
                                                                            <div class="x-interact-publish-cont">
                                                                                <textarea contenteditable="true" v-model="replyContentChild" class="text-area placeholder" :placeholder="replyPlaceholderChild"></textarea>
                                                                                <div class="other"></div>
                                                                            </div>
                                                                            <div class="x-interact-publish-panel-center">

                                                                            </div>
                                                                            <div class="x-interact-publish-opt ">
                                                                                <span class="publishButton" @click="addReplyCommentChild(itemChild,item)">提交</span>
                                                                                <span class="publishButton" @click="cancelReply()">取消</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                </div>
                                                            </li>
                                                        </ul>
                                                    </div>

                                                </div>
                                            </li>
                                        </ul>
                                        <div class="xcp-list-loader " @click="moreComment()">
                                            <span>{{moreTips}}</span>

                                        </div>
                                    </div>
                                </div>

                            </section>
                        </div>
                        <!-- Blog Details Wrapper Area End -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Blog Main Area End Here -->



        <!-- Footer Area Start Here -->
        <footer th:replace="home/public/footer::footer"></footer>
        <!-- Footer Area End Here -->
    </div>


    <!-- Scroll to Top Start -->
    <a class="scroll-to-top" href="#">
        <i class="ion-chevron-up"></i>
    </a>
    <!-- Scroll to Top End -->

    <!-- JS
============================================ -->

    <!-- jQuery JS -->
    <script src="/static/assets/js/vendor/jquery-3.5.1.min.js"></script>
    <!-- jQuery Migrate JS -->
    <script src="/static/assets/js/vendor/jQuery-migrate-3.3.0.min.js"></script>
    <!-- Modernizer JS -->
    <script src="/static/assets/js/vendor/modernizr-2.8.3.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="/static/assets/js/vendor/bootstrap.bundle.min.js"></script>
    <!-- Slick Slider JS -->
    <script src="/static/assets/js/plugins/slick.min.js"></script>
    <!-- Countdown JS -->
    <script src="/static/assets/js/plugins/jquery.countdown.min.js"></script>
    <!-- Ajax JS -->
    <script src="/static/assets/js/plugins/jquery.ajaxchimp.min.js"></script>
    <!-- Jquery Nice Select JS -->
    <script src="/static/assets/js/plugins/jquery.nice-select.min.js"></script>
    <!-- Jquery Ui JS -->
    <script src="/static/assets/js/plugins/jquery-ui.min.js"></script>
    <!-- jquery magnific popup js -->
    <script src="/static/assets/js/plugins/jquery.magnific-popup.min.js"></script>

    <!-- Main JS -->
    <script src="/static/assets/js/main.js"></script>


    <script src="/static/home/cart/js/vue2.min.js"></script>
    <script src="/static/home/cart/js/vue-resource.min.js"></script>
    <script type="text/javascript">
        var userId='[[${session?.user?.id}]]';
        var currNoteId='[[${noteId}]]';
        layui.use(['form', 'layer'], function () {
            var form = layui.form,
                layer = layui.layer;
        })
        var vm = new Vue({
            el:'#app' , // 构造参数，实例需要监听的模型范围，对象 #app 下的任何元素都可以背vue操控
            data:{      // data 重点 vue的模型
                favorNum:0,         // 点赞数
                noteInfo:{},         // 笔记信息
                userInfo:{},         // 用户信息
                collectNum:0,       // 收藏数
                content:"",//评论输入框内容
                replyContent:"",//回复评论输入框内容
                replyContentChild:"",//回复评论输入框内容
                commentList:[],       //评论列表
                currPageNum:1,          //当前评论页数
                pageSize:10,             //评论每页大小
                commentNum:0,            //评论总条数
                currUserId:"",               //当前登录用户ID
                active: '',
                moreTips:"查看更多评论", //
                showReply:"display:none", //是否显式回复下textarea
                showReplyChild:"display:none", //是否显式回复下textarea
                replyId:"", //被回复的item.id-root
                currReplyId:"", //当前被回复的item.id
                replyPlaceholder:"请输入回复内容",
                replyPlaceholderChild:"请输入回复内容"
            },
            filters:{ // 过滤器 对数据实现转换 可以定义全局的 也可以定义局部的 这个是局部的 只有vue的实例才可以使用

            },
            created(){
                this.queryCommentList();
              if(!userId||userId==null||userId==''||userId=='null'){
                  window.location.href="/home/login"
              }else{
                  this.queryUserInfo();
                  this.currUserId=userId;
              }
            },
            // 这个方法就相当于jq的ready()方法
            mounted:function () { //生命周期的一部分，在实例化创建完成后，需要查询某一个方法 需要定义一个mounted 方法
                this.$nextTick(function () {  // 代码保证 this.$el 在 document 中
                    this.queryNoteDetail();
                    // 也可以使用 vm.cartView();
                });
            },
            methods:{   // 所有事件的绑定都会在 methods 中定义
                mouseEnter: function(){
                    this.active = 'display:inline;right:0';
                    console.log("mouseEnter : ",this.active )
                },
                mouseLeave: function () {
                    this.active = 'display:none';
                    console.log("mouseLeave : ",this.active )
                },
                replyComment:function (item){
                    console.log("replyComment.....")
                    this.showReply='display:inline';
                    this.replyId=item.id;
                    this.replyPlaceholder="@//"+item.userName+":";
                },
                replyCommentChild:function (itemChild,item){
                    console.log("replyCommentChild.....")
                    this.showReplyChild='display:inline';
                    this.replyId=item.id;
                    this.currReplyId=itemChild.id;
                    this.replyPlaceholderChild="@//"+itemChild.replyUserName+":";
                },

                //取消回复
                cancelReply:function (){
                    this.showReply='display:none';
                    this.showReplyChild='display:none';
                    this.replyId='';
                    this.replyContent='';
                    this.replyContentChild='';
                    this.replyPlaceholder='请输入回复内容';
                    this.replyPlaceholderChild='请输入回复内容';
                },

                // queryNoteDetail() 请求当前的note的信息
                queryNoteDetail:function () {
                    // 通过this 来调用这个 http方法
                    // 通过.then 方法来接受回调  res 就是我们最终拿到的结果
                    // 这个也是可以传递参数的
                    var _this = this;
                    this.$http.post("/home/note/detailInfo?id="+currNoteId).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        console.log(res);
                        _this.noteInfo = res.body.data;
                        _this.favorNum = res.body.data.favorNum;
                        _this.collectNum = res.body.data.collectNum;
                    })

                },

                //点赞 或 取消点赞
                checkFavor(){
                    var _this = this;
                    this.$http.post("/home/userNote/add",{"actionType":1,"noteId":currNoteId}).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        if(res.body.success){
                            //说明成功
                            _this.content="";
                            // layer.msg("操作成功！", {icon: 1, time: 1500});
                            _this.queryNoteDetail();
                        }else{
                            layer.msg(res.body.msg, {icon: 2, time: 1500});
                            return false
                        }
                    })
                },
                //收藏或取消收藏
                checkCollect(){
                    var _this = this;
                    this.$http.post("/home/userNote/add",{"actionType":2,"noteId":currNoteId}).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        if(res.body.success){
                            //说明成功
                            _this.content="";
                            // layer.msg("操作成功！", {icon: 1, time: 1500});
                            _this.queryNoteDetail();
                        }else{
                            layer.msg(res.body.msg, {icon: 2, time: 1500});
                            return false
                        }
                    })
                },

               //查询用户信息
                queryUserInfo:function () {
                    var _this = this;
                    this.$http.get("/home/user/detailInfo?id="+userId).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        _this.userInfo = res.body.data;
                    })
                },
                addComment(){
                    var _this = this;
                    if(!_this.content||_this.content==''){
                        layer.msg("请输入评论内容！", {icon: 2, time: 1500});
                        return false
                    }
                    this.$http.post("/home/userNote/add",{"actionType":3,"comment":_this.content,"noteId":currNoteId}).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        console.log("addComment 结果",res);
                        if(res.body.success){
                            //说明成功
                            _this.content="";
                            // layer.msg("操作成功！", {icon: 1, time: 1500});
                            _this.queryCommentList();
                        }else{
                            layer.msg(res.body.msg, {icon: 2, time: 1500});
                            return false
                        }
                        // _this.noteInfo = res.body.data;
                        // _this.favorNum = res.body.data.favorNum;
                        // _this.collectNum = res.body.data.collectNum;
                    })
                },
                // 回复提交评论
                addReplyComment(item){
                    var _this = this;
                    if(!_this.replyContent||_this.replyContent==''){
                        layer.msg("请输入回复内容！", {icon: 2, time: 1500});
                        return false
                    }
                    this.$http.post("/home/userNote/add?privUserId="+item.userId,{"actionType":3,"comment":_this.replyContent,"noteId":currNoteId,"replyId":item.id,"replyUserId":_this.currUserId,}).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        console.log("addComment 结果",res);
                        if(res.body.success){
                            //说明成功
                            _this.content="";
                            _this.replyContent="";
                            _this.replyContentChild="";
                            this.showReply='display:none';
                            this.showReplyChild='display:none';
                            // layer.msg("操作成功！", {icon: 1, time: 1500});
                            _this.queryCommentList();
                        }else{
                            layer.msg(res.body.msg, {icon: 2, time: 1500});
                            return false
                        }
                        // _this.noteInfo = res.body.data;
                        // _this.favorNum = res.body.data.favorNum;
                        // _this.collectNum = res.body.data.collectNum;
                    })
                },
                // 回复提交评论
                addReplyCommentChild(itemChild,item){
                    var _this = this;
                    if(!_this.replyContentChild||_this.replyContentChild==''){
                        layer.msg("请输入回复内容！", {icon: 2, time: 1500});
                        return false
                    }
                    this.$http.post("/home/userNote/add?privUserId="+itemChild.replyUserId,{"actionType":3,"comment":_this.replyContentChild,"noteId":currNoteId,"replyId":item.id,"replyUserId":_this.currUserId,}).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        console.log("addComment 结果",res);
                        if(res.body.success){
                            //说明成功
                            _this.content="";
                            _this.replyContent="";
                            _this.replyContentChild="";
                            this.showReply='display:none';
                            this.showReplyChild='display:none';
                            // layer.msg("操作成功！", {icon: 1, time: 1500});
                            _this.queryCommentList();
                        }else{
                            layer.msg(res.body.msg, {icon: 2, time: 1500});
                            return false
                        }
                        // _this.noteInfo = res.body.data;
                        // _this.favorNum = res.body.data.favorNum;
                        // _this.collectNum = res.body.data.collectNum;
                    })
                },
                deleteComment(id){
                    var _this = this;
                    this.$http.post("/home/userNote/delete?idList="+id).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        if(res.body.success){
                            //说明成功
                            _this.currPageNum=1;
                            _this.queryCommentList();
                        }else{
                            layer.msg(res.body.msg, {icon: 2, time: 1500});
                            return false
                        }
                        // _this.noteInfo = res.body.data;
                        // _this.favorNum = res.body.data.favorNum;
                        // _this.collectNum = res.body.data.collectNum;
                    })
                },
                queryCommentList(){
                    var _this = this;
                    this.$http.post("/home/userNote/list?child=1&actionType=3&pageNum="+_this.currPageNum+"&pageSize="+_this.pageSize+"&noteId="+currNoteId).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        console.log("queryCommentList : ",res)
                        _this.commentList = res.body.data.rows;
                        _this.commentNum = res.body.data.total;
                        if(res.body.data.rows.length<10){//没有更多了
                            _this.moreTips="没有更多了"
                        }else{
                            _this.moreTips="查看更多评论"
                        }
                    })
                },
                moreComment(){
                    var _this = this;
                    if(_this.moreTips=="没有更多了"){
                        return false;
                    }
                    this.currPageNum=this.currPageNum+1;
                    var _this = this;
                    this.$http.post("/home/userNote/list?actionType=3&pageNum="+_this.currPageNum+"&pageSize="+_this.pageSize+"&noteId="+currNoteId).then(function (res) {
                        // 这块的 body里面是我们要用的数据 这是vue-resource 插件封装好的
                        console.log("queryCommentList : ",res)
                        if(res.body.data.rows.length<10){//没有更多了
                            _this.moreTips="没有更多了"
                            return false;
                        }else{
                            _this.moreTips="查看更多评论"
                            _this.commentList = _this.commentList.concat(res.body.data.rows);
                        }
                    })
                }
            }
        });


    </script>
</body>

</html>
